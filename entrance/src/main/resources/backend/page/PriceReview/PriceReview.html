<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二级商品审核（价格审核）页面</title>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="../../plugins/element-ui/index.css"/>
    <link rel="stylesheet" href="../../styles/common.css"/>
    <link rel="stylesheet" href="../../styles/page.css"/>
</head>
<body>
<div class="dashboard-container" id="price-review-app">
    <div class="container">
        <el-table :data="tableData" stripe class="tableBox">
            <el-table-column prop="id" label="商品ID"></el-table-column>
            <el-table-column prop="name" label="商品名称"></el-table-column>
            <el-table-column prop="price" label="商品价格"></el-table-column>
            <el-table-column prop="image" label="商品图片" align="center">
                <template slot-scope="{ row }">
                    <el-image style="width: auto; height: 40px; cursor: pointer;"
                              :src="getImage(row.image)"
                              :preview-src-list="[ `/spz/common/download?name=${row.image}` ]">
                        <div slot="error" class="image-slot">
                            <img src="./../../images/noImg.png" style="width: auto; height: 40px;">
                        </div>
                    </el-image>
                </template>
            </el-table-column>
            <el-table-column prop="user" label="发布用户"></el-table-column>
            <el-table-column prop="publishTime" label="发布时间">
                <template slot-scope="scope">
                    {{scope.row.publishTime}}
                </template>
            </el-table-column>
            <el-table-column label="操作" width="160" align="center">
                <template slot-scope="scope">
                    <el-button type="text" size="small" @click="viewDetail(scope.row)">查看详情</el-button>
                </template>
            </el-table-column>
        </el-table>
    </div>

    <!-- 商品详情弹窗 -->
    <el-dialog :title="detailData.title" :visible.sync="detailData.dialogVisible" width="30%">
        <el-form class="demo-form-inline" label-width="100px">
            <el-form-item label="商品ID：">
                <span>{{detailData.id}}</span>
            </el-form-item>
            <el-form-item label="商品名称：">
                <span>{{detailData.name}}</span>
            </el-form-item>
            <el-form-item label="商品价格：">
                <span>{{detailData.price}}</span>
            </el-form-item>
            <el-form-item label="商品描述：">
                <span>{{detailData.description}}</span>
            </el-form-item>
            <el-form-item label="商品图片：">
                <el-image style="width: auto; height: 40px;" :src="getImage(detailData.image)"></el-image>
            </el-form-item>
            <el-form-item label="发布用户：">
                <span>{{detailData.user}}</span>
            </el-form-item>
            <el-form-item label="发布用户ID：">
                <span>{{detailData.userId}}</span>
            </el-form-item>
            <el-form-item label="发布时间：">
                <span>{{detailData.publishTime}}</span>
            </el-form-item>
            <el-form-item v-if="showRejectReason" label="不通过原因：">
                <el-input type="textarea" v-model="rejectReason" placeholder="请填写不通过原因"></el-input>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button size="medium" @click="detailData.dialogVisible = false">取消</el-button>
            <el-button type="primary" size="medium" @click="approveItem()">通过审核</el-button>
            <el-button type="danger" size="medium" @click="rejectItem()">不通过审核</el-button>
        </span>
    </el-dialog>
</div>

<script src="../../plugins/vue/vue.js"></script>
<script src="../../plugins/element-ui/index.js"></script>
<script src="../../plugins/axios/axios.min.js"></script>
<script src="../../api/priceReview.js"></script>

<script>
    new Vue({
        el: '#price-review-app',
        data() {
            return {
                tableData: [],
                detailData: {
                    title: '商品详情',
                    dialogVisible: false,
                    id: '',
                    name: '',
                    price: '',
                    description: '',
                    image: '',
                    user: '',
                    userId: '',
                    publishTime: ''
                },
                showRejectReason: false,
                rejectReason: ''
            }
        },
        created() {
            this.init();
        },
        methods: {
            async init() {
                // 初始化数据
                try {
                    const response = await getSecondHandItemsForPriceReview({ page: 1, size: 10 }); // 获取商品列表
                    this.tableData = response.data.items;
                } catch (error) {
                    console.error('获取商品列表失败:', error);
                }
            },
            async viewDetail(row) {
                // 获取商品详情
                try {
                    const response = await querySecondHandItemPriceDetailById(row.id); // 获取商品详情
                    if (response.data) {
                        this.detailData = { ...this.detailData, ...response.data, dialogVisible: true };
                    }
                } catch (error) {
                    console.error('获取商品详情失败:', error);
                }
            },
            async approveItem() {
                // 通过审核操作
                try {
                    await approveSecondHandItemPrice({ id: this.detailData.id }); // 通过价格审核
                    this.$message.success('审核通过');
                    this.detailData.dialogVisible = false;
                    this.init(); // 重新加载商品列表
                } catch (error) {
                    console.error('审核通过失败:', error);
                }
            },
            async rejectItem() {
                // 打开不通过原因输入框
                if (!this.showRejectReason) {
                    this.showRejectReason = true;
                    return;
                }
                // 检查不通过原因是否填写
                if (!this.rejectReason) {
                    this.$message.error('请填写不通过原因');
                    return;
                }
                // 不通过审核操作
                try {
                    await rejectSecondHandItemPrice({ id: this.detailData.id, reason: this.rejectReason }); // 不通过价格审核
                    this.$message.success('审核不通过');
                    this.detailData.dialogVisible = false;
                    this.init(); // 重新加载商品列表
                } catch (error) {
                    console.error('审核不通过失败:', error);
                }
            },
            getImage(image) {
                return `/spz/common/download?name=${image}`;
            }
        }
    });
</script>

</body>
</html>
